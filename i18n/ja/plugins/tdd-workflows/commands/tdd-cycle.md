---
description: 厳格なレッド-グリーン-リファクタ規律を伴う包括的なテスト駆動開発(TDD)ワークフローを実行します。
---

> **[English](../../../plugins/tdd-workflows/commands/tdd-cycle.md)** | **日本語**

厳格なレッド-グリーン-リファクタ規律を伴う包括的なテスト駆動開発(TDD)ワークフローを実行します。

[拡張思考: このワークフローは、調整されたエージェントオーケストレーションを通じてテストファーストの開発を強制します。TDDサイクルの各フェーズは、失敗優先の検証、段階的な実装、継続的なリファクタリングで厳格に強制されます。ワークフローは、設定可能なカバレッジ閾値を持つ単一テストとテストスイートの両方のアプローチをサポートします。]

## 設定

### カバレッジ閾値
- 最小ラインカバレッジ: 80%
- 最小ブランチカバレッジ: 75%
- クリティカルパスカバレッジ: 100%

### リファクタリングトリガー
- 循環的複雑度 > 10
- メソッド長 > 20行
- クラス長 > 200行
- 重複コードブロック > 3行

## フェーズ1: テスト仕様と設計

### 1. 要件分析
- Taskツールを使用し、subagent_type="comprehensive-review::architect-review"
- プロンプト: "次の要件を分析してください: $ARGUMENTS。受け入れ基準を定義し、エッジケースを特定し、テストシナリオを作成してください。包括的なテスト仕様を出力してください。"
- 出力: テスト仕様、受け入れ基準、エッジケースマトリックス
- 検証: すべての要件に対応するテストシナリオがあることを確認

### 2. テストアーキテクチャ設計
- Taskツールを使用し、subagent_type="unit-testing::test-automator"
- プロンプト: "テスト仕様に基づいて次のテストアーキテクチャを設計してください: $ARGUMENTS。テスト構造、フィクスチャ、モック、テストデータ戦略を定義してください。テスト可能性と保守性を確保してください。"
- 出力: テストアーキテクチャ、フィクスチャ設計、モック戦略
- 検証: アーキテクチャが独立した、高速で信頼性の高いテストをサポート

## フェーズ2: レッド - 失敗するテストを書く

### 3. ユニットテストを書く(失敗)
- Taskツールを使用し、subagent_type="unit-testing::test-automator"
- プロンプト: "次の失敗するユニットテストを書いてください: $ARGUMENTS。テストは最初に失敗しなければなりません。エッジケース、エラーシナリオ、ハッピーパスを含めてください。プロダクションコードは実装しないでください。"
- 出力: 失敗するユニットテスト、テストドキュメント
- **重要**: すべてのテストが期待されるエラーメッセージで失敗することを検証

### 4. テスト失敗を検証
- Taskツールを使用し、subagent_type="tdd-workflows::code-reviewer"
- プロンプト: "次のすべてのテストが正しく失敗していることを検証してください: $ARGUMENTS。失敗が正しい理由(実装の欠如、テストエラーではない)であることを確認してください。偽陽性がないことを確認してください。"
- 出力: テスト失敗検証レポート
- **ゲート**: すべてのテストが適切に失敗するまで続行しない

## フェーズ3: グリーン - テストを成功させる

### 5. 最小限の実装
- Taskツールを使用し、subagent_type="backend-development::backend-architect"
- プロンプト: "次のテストを成功させるための最小限のコードを実装してください: $ARGUMENTS。テストをグリーンにすることにのみ焦点を当ててください。追加機能や最適化は加えないでください。シンプルに保ってください。"
- 出力: 最小限の動作する実装
- 制約: テストを成功させるために必要なコードのみ

### 6. テスト成功を検証
- Taskツールを使用し、subagent_type="unit-testing::test-automator"
- プロンプト: "次のすべてのテストを実行し、成功することを検証してください: $ARGUMENTS。テストカバレッジメトリクスをチェックしてください。誤って壊れたテストがないことを確認してください。"
- 出力: テスト実行レポート、カバレッジメトリクス
- **ゲート**: 続行する前にすべてのテストが成功しなければならない

## フェーズ4: リファクタ - コード品質を改善

### 7. コードリファクタリング
- Taskツールを使用し、subagent_type="tdd-workflows::code-reviewer"
- プロンプト: "テストをグリーンに保ちながら次の実装をリファクタリングしてください: $ARGUMENTS。SOLID原則を適用し、重複を削除し、命名を改善し、パフォーマンスを最適化してください。各リファクタリング後にテストを実行してください。"
- 出力: リファクタリング済みコード、リファクタリングレポート
- 制約: テストは全体を通してグリーンに保つ必要がある

### 8. テストリファクタリング
- Taskツールを使用し、subagent_type="unit-testing::test-automator"
- プロンプト: "次のテストをリファクタリングしてください: $ARGUMENTS。テストの重複を削除し、テスト名を改善し、共通フィクスチャを抽出し、テストの可読性を向上させてください。テストが同じカバレッジを提供することを確認してください。"
- 出力: リファクタリング済みテスト、改善されたテスト構造
- 検証: カバレッジメトリクスが変わらないか改善

## フェーズ5: 統合とシステムテスト

### 9. 統合テストを書く(まず失敗)
- Taskツールを使用し、subagent_type="unit-testing::test-automator"
- プロンプト: "次の失敗する統合テストを書いてください: $ARGUMENTS。コンポーネント間の相互作用、API契約、データフローをテストしてください。テストは最初に失敗しなければなりません。"
- 出力: 失敗する統合テスト
- 検証: テストが統合ロジックの欠如により失敗

### 10. 統合を実装
- Taskツールを使用し、subagent_type="backend-development::backend-architect"
- プロンプト: "統合テストを成功させるために次の統合コードを実装してください: $ARGUMENTS。コンポーネント間の相互作用とデータフローにフォーカスしてください。"
- 出力: 統合実装
- 検証: すべての統合テストが成功

## フェーズ6: 継続的改善サイクル

### 11. パフォーマンスとエッジケーステスト
- Taskツールを使用し、subagent_type="unit-testing::test-automator"
- プロンプト: "次のパフォーマンステストと追加のエッジケーステストを追加してください: $ARGUMENTS。ストレステスト、境界テスト、エラー回復テストを含めてください。"
- 出力: 拡張テストスイート
- メトリクス: テストカバレッジとシナリオカバレッジの増加

### 12. 最終コードレビュー
- Taskツールを使用し、subagent_type="comprehensive-review::architect-review"
- プロンプト: "次の包括的なレビューを実行してください: $ARGUMENTS。TDDプロセスが守られたことを検証し、コード品質、テスト品質、カバレッジをチェックしてください。改善提案をしてください。"
- 出力: レビューレポート、改善提案
- アクション: グリーンテストを維持しながら重要な提案を実装

## 段階的開発モード

テストごとの開発の場合:
1. 1つの失敗するテストを書く
2. そのテストのみを成功させる
3. 必要に応じてリファクタリング
4. 次のテストで繰り返し

一度に1つのテストにフォーカスするには`--incremental`フラグを追加してこのアプローチを使用します。

## テストスイートモード

包括的なテストスイート開発の場合:
1. 機能/モジュールのすべてのテストを書く(失敗)
2. すべてのテストを成功させるコードを実装
3. モジュール全体をリファクタリング
4. 統合テストを追加

バッチテスト開発には`--suite`フラグを追加してこのアプローチを使用します。

## 検証チェックポイント

### レッドフェーズ検証
- [ ] すべてのテストが実装前に書かれている
- [ ] すべてのテストが意味のあるエラーメッセージで失敗
- [ ] テスト失敗が実装の欠如による
- [ ] 偶然成功するテストがない

### グリーンフェーズ検証
- [ ] すべてのテストが成功
- [ ] テスト要件を超える追加コードなし
- [ ] カバレッジが最小閾値を満たす
- [ ] 成功させるためにテストが修正されていない

### リファクタフェーズ検証
- [ ] リファクタリング後もすべてのテストが成功
- [ ] コード複雑度が削減
- [ ] 重複が排除
- [ ] パフォーマンスが改善または維持
- [ ] テストの可読性が改善

## カバレッジレポート

各フェーズ後にカバレッジレポートを生成:
- ラインカバレッジ
- ブランチカバレッジ
- 関数カバレッジ
- ステートメントカバレッジ

## 失敗リカバリ

TDD規律が破られた場合:
1. **即座に停止**
2. どのフェーズが違反されたかを特定
3. 最後の有効な状態にロールバック
4. 正しいフェーズから再開
5. 学んだ教訓を文書化

## TDDメトリクス追跡

追跡とレポート:
- 各フェーズの時間(レッド/グリーン/リファクタ)
- テスト-実装サイクルの数
- カバレッジの進行
- リファクタリング頻度
- 欠陥逃避率

## 避けるべきアンチパターン

- テスト前に実装を書く
- すでに成功するテストを書く
- リファクタフェーズをスキップ
- テストなしで複数の機能を書く
- テストを成功させるために修正
- 失敗するテストを無視
- 実装後にテストを書く

## 成功基準

- 100%のコードがテストファースト
- すべてのテストが継続的に成功
- カバレッジが閾値を超える
- コード複雑度が制限内
- カバーされたコードで欠陥ゼロ
- 明確なテストドキュメント
- 高速なテスト実行(ユニットテストは5秒未満)

## 注記

- 厳格なレッド-グリーン-リファクタ規律を強制
- 各フェーズは次に進む前に完了しなければならない
- テストが仕様
- テストが書きにくい場合、設計の改善が必要
- リファクタリングはオプションではない
- テスト実行を高速に保つ
- テストは独立して分離されるべき

TDD実装対象: $ARGUMENTS
