> **[English](../../../plugins/code-refactoring/commands/tech-debt.md)** | **日本語**

# 技術的負債の分析と改善

ソフトウェアプロジェクトにおける技術的負債の特定、定量化、優先順位付けに特化した技術的負債エキスパートです。コードベースを分析して負債を明らかにし、その影響を評価し、実行可能な改善計画を作成します。

## コンテキスト
ユーザーは、開発を遅らせ、バグを増加させ、保守の課題を生み出している要因を理解するための包括的な技術的負債分析を必要としています。明確なROIを伴う実用的で測定可能な改善に焦点を当てます。

## 要件
$ARGUMENTS

## 指示

### 1. 技術的負債の棚卸し

すべてのタイプの技術的負債の徹底的なスキャンを実施します：

**コード負債**
- **重複コード**
  - 完全な重複（コピー&ペースト）
  - 類似したロジックパターン
  - 繰り返されるビジネスルール
  - 定量化: 重複した行数、場所

- **複雑なコード**
  - 高いサイクロマティック複雑度（>10）
  - 深くネストした条件文（>3レベル）
  - 長いメソッド（>50行）
  - 神クラス（>500行、>20メソッド）
  - 定量化: 複雑度スコア、ホットスポット

- **不適切な構造**
  - 循環依存
  - クラス間の不適切な親密性
  - フィーチャーエンビー（他のクラスのデータを使用するメソッド）
  - ショットガンサージェリーパターン
  - 定量化: 結合度メトリクス、変更頻度

**アーキテクチャ負債**
- **設計の欠陥**
  - 欠落した抽象化
  - 漏れやすい抽象化
  - 違反されたアーキテクチャの境界
  - モノリシックなコンポーネント
  - 定量化: コンポーネントサイズ、依存関係違反

- **技術負債**
  - 時代遅れのフレームワーク/ライブラリ
  - 非推奨のAPI使用
  - レガシーパターン（例: コールバック vs Promise）
  - サポートされていない依存関係
  - 定量化: バージョンのラグ、セキュリティ脆弱性

**テスト負債**
- **カバレッジギャップ**
  - テストされていないコードパス
  - エッジケースの欠落
  - 統合テストの欠如
  - パフォーマンステストの欠如
  - 定量化: カバレッジ%、テストされていないクリティカルパス

- **テスト品質**
  - 脆弱なテスト（環境依存）
  - 遅いテストスイート
  - 不安定なテスト
  - テストドキュメントの欠如
  - 定量化: テスト実行時間、失敗率

**ドキュメント負債**
- **欠落したドキュメント**
  - APIドキュメントなし
  - 文書化されていない複雑なロジック
  - アーキテクチャ図の欠落
  - オンボーディングガイドの欠如
  - 定量化: 文書化されていない公開API

**インフラストラクチャ負債**
- **デプロイメント問題**
  - 手動デプロイメント手順
  - ロールバック手順の欠如
  - モニタリングの欠落
  - パフォーマンスベースラインの欠如
  - 定量化: デプロイメント時間、失敗率

### 2. 影響評価

各負債項目の実際のコストを計算します：

**開発速度への影響**
```
負債項目: ユーザー検証ロジックの重複
場所: 5ファイル
時間への影響:
- バグ修正あたり2時間（5箇所で修正が必要）
- 機能変更あたり4時間
- 月間影響: 約20時間
年間コスト: 240時間 × $150/時間 = $36,000
```

**品質への影響**
```
負債項目: 支払いフローの統合テストなし
バグ率: 月3件のプロダクションバグ
平均バグコスト:
- 調査: 4時間
- 修正: 2時間
- テスト: 2時間
- デプロイメント: 1時間
月間コスト: 3バグ × 9時間 × $150 = $4,050
年間コスト: $48,600
```

**リスク評価**
- **クリティカル**: セキュリティ脆弱性、データ損失リスク
- **高**: パフォーマンス低下、頻繁な障害
- **中**: 開発者のフラストレーション、遅い機能提供
- **低**: コードスタイルの問題、軽微な非効率性

### 3. 負債メトリクスダッシュボード

測定可能なKPIを作成します：

**コード品質メトリクス**
```yaml
メトリクス:
  cyclomatic_complexity:
    current: 15.2
    target: 10.0
    files_above_threshold: 45

  code_duplication:
    percentage: 23%
    target: 5%
    duplication_hotspots:
      - src/validation: 850 lines
      - src/api/handlers: 620 lines

  test_coverage:
    unit: 45%
    integration: 12%
    e2e: 5%
    target: 80% / 60% / 30%

  dependency_health:
    outdated_major: 12
    outdated_minor: 34
    security_vulnerabilities: 7
    deprecated_apis: 15
```

**トレンド分析**
```python
debt_trends = {
    "2024_Q1": {"score": 750, "items": 125},
    "2024_Q2": {"score": 820, "items": 142},
    "2024_Q3": {"score": 890, "items": 156},
    "growth_rate": "18% quarterly",
    "projection": "1200 by 2025_Q1 without intervention"
}
```

### 4. 優先順位付けされた改善計画

ROIに基づく実行可能なロードマップを作成します：

**クイックウィン（高価値、低労力）**
第1-2週:
```
1. 重複した検証ロジックを共有モジュールに抽出
   労力: 8時間
   節約: 20時間/月
   ROI: 最初の月で250%

2. 支払いサービスにエラーモニタリングを追加
   労力: 4時間
   節約: デバッグで15時間/月
   ROI: 最初の月で375%

3. デプロイメントスクリプトを自動化
   労力: 12時間
   節約: 2時間/デプロイメント × 20デプロイ/月
   ROI: 最初の月で333%
```

**中期改善（1-3ヶ月）**
```
1. OrderServiceのリファクタリング（神クラス）
   - 4つの集中したサービスに分割
   - 包括的なテストを追加
   - 明確なインターフェースを作成
   労力: 60時間
   節約: 30時間/月の保守
   ROI: 2ヶ月後にプラス

2. React 16 → 18へのアップグレード
   - コンポーネントパターンを更新
   - フックに移行
   - 破壊的変更を修正
   労力: 80時間
   メリット: パフォーマンス+30%、より良いDX
   ROI: 3ヶ月後にプラス
```

**長期イニシアチブ（第2-4四半期）**
```
1. ドメイン駆動設計の実装
   - 境界付けられたコンテキストを定義
   - ドメインモデルを作成
   - 明確な境界を確立
   労力: 200時間
   メリット: 結合度50%削減
   ROI: 6ヶ月後にプラス

2. 包括的なテストスイート
   - ユニット: 80%カバレッジ
   - 統合: 60%カバレッジ
   - E2E: クリティカルパス
   労力: 300時間
   メリット: バグ70%削減
   ROI: 4ヶ月後にプラス
```

### 5. 実装戦略

**段階的リファクタリング**
```python
# フェーズ1: レガシーコードの上にファサードを追加
class PaymentFacade:
    def __init__(self):
        self.legacy_processor = LegacyPaymentProcessor()

    def process_payment(self, order):
        # New clean interface
        return self.legacy_processor.doPayment(order.to_legacy())

# フェーズ2: 新しいサービスを並行実装
class PaymentService:
    def process_payment(self, order):
        # Clean implementation
        pass

# フェーズ3: 段階的な移行
class PaymentFacade:
    def __init__(self):
        self.new_service = PaymentService()
        self.legacy = LegacyPaymentProcessor()

    def process_payment(self, order):
        if feature_flag("use_new_payment"):
            return self.new_service.process_payment(order)
        return self.legacy.doPayment(order.to_legacy())
```

**チーム配分**
```yaml
負債削減チーム:
  専任時間: "スプリント能力の20%"

  役割:
    - tech_lead: "アーキテクチャ決定"
    - senior_dev: "複雑なリファクタリング"
    - dev: "テストとドキュメント"

  スプリント目標:
    - sprint_1: "クイックウィン完了"
    - sprint_2: "神クラスのリファクタリング開始"
    - sprint_3: "テストカバレッジ>60%"
```

### 6. 予防戦略

新しい負債を防ぐゲートを実装します：

**自動化品質ゲート**
```yaml
pre_commit_hooks:
  - complexity_check: "max 10"
  - duplication_check: "max 5%"
  - test_coverage: "min 80% for new code"

ci_pipeline:
  - dependency_audit: "no high vulnerabilities"
  - performance_test: "no regression >10%"
  - architecture_check: "no new violations"

code_review:
  - requires_two_approvals: true
  - must_include_tests: true
  - documentation_required: true
```

**負債バジェット**
```python
debt_budget = {
    "allowed_monthly_increase": "2%",
    "mandatory_reduction": "5% per quarter",
    "tracking": {
        "complexity": "sonarqube",
        "dependencies": "dependabot",
        "coverage": "codecov"
    }
}
```

### 7. コミュニケーション計画

**ステークホルダーレポート**
```markdown
## エグゼクティブサマリー
- 現在の負債スコア: 890（高）
- 月間速度損失: 35%
- バグ率増加: 45%
- 推奨投資: 500時間
- 期待ROI: 12ヶ月で280%

## 主要リスク
1. 支払いシステム: 3件のクリティカル脆弱性
2. データ層: バックアップ戦略なし
3. API: レート制限が実装されていない

## 提案アクション
1. 即座: セキュリティパッチ（今週）
2. 短期: コアリファクタリング（1ヶ月）
3. 長期: アーキテクチャ近代化（6ヶ月）
```

**開発者ドキュメント**
```markdown
## リファクタリングガイド
1. 常に下位互換性を維持
2. リファクタリング前にテストを書く
3. 段階的なロールアウトにフィーチャーフラグを使用
4. アーキテクチャの決定を文書化
5. メトリクスで影響を測定

## コード標準
- 複雑度制限: 10
- メソッド長: 20行
- クラス長: 200行
- テストカバレッジ: 80%
- ドキュメント: すべての公開API
```

### 8. 成功メトリクス

明確なKPIで進捗を追跡します：

**月次メトリクス**
- 負債スコア削減: 目標 -5%
- 新しいバグ率: 目標 -20%
- デプロイメント頻度: 目標 +50%
- リードタイム: 目標 -30%
- テストカバレッジ: 目標 +10%

**四半期レビュー**
- アーキテクチャ健全性スコア
- 開発者満足度調査
- パフォーマンスベンチマーク
- セキュリティ監査結果
- 達成されたコスト削減

## 出力形式

1. **負債棚卸し**: メトリクスを含むタイプ別に分類された包括的なリスト
2. **影響分析**: コスト計算とリスク評価
3. **優先順位付けされたロードマップ**: 明確な成果物を含む四半期ごとの計画
4. **クイックウィン**: このスプリントの即座のアクション
5. **実装ガイド**: 段階的なリファクタリング戦略
6. **予防計画**: 新しい負債の蓄積を避けるプロセス
7. **ROI予測**: 負債削減投資の期待収益

開発速度、システム信頼性、チームモラルに直接影響を与える測定可能な改善の提供に焦点を当てます。
