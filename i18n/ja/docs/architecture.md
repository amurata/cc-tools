# アーキテクチャ & 設計原則

> **[English](../../../docs/architecture.md)** | **日本語**

このマーケットプレイスは、粒度、組み合わせ可能性、最小限のトークン使用に焦点を当てた業界のベストプラクティスに従っています。

## コア哲学

### 単一責任の原則

- 各プラグインは **1つのことをうまく実行** (Unix哲学)
- 明確で焦点を絞った目的(5-10語で説明可能)
- プラグンの平均サイズ: **3.4コンポーネント** (Anthropicの2-8パターンに従う)
- **肥大化したプラグインゼロ** - すべてのプラグインが焦点を絞り目的を持つ

### バンドルよりも組み合わせ可能性

- ニーズに基づいてプラグインをミックス&マッチ
- ワークフローオーケストレーターが焦点を絞ったプラグインを組み合わせる
- 強制的な機能バンドルなし
- プラグイン間の明確な境界

### コンテキスト効率

- 小さなツール = 高速な処理
- LLMコンテキストウィンドウへの適合性向上
- より正確で焦点を絞った応答
- 必要なものだけをインストール

### 保守性

- 単一目的 = 更新が容易
- 明確な境界 = 分離された変更
- 重複の削減 = シンプルな保守
- 分離された依存関係

## 粒度の高いプラグインアーキテクチャ

### プラグイン分布

- **63個の焦点を絞ったプラグイン** 特定のユースケースに最適化
- **23個の明確なカテゴリー** 各カテゴリー1-6個のプラグインで発見が容易
- ドメイン別に整理:
  - **開発**: 4プラグイン(デバッグ、バックエンド、フロントエンド、マルチプラットフォーム)
  - **セキュリティ**: 4プラグイン(スキャン、コンプライアンス、バックエンドAPI、フロントエンドモバイル)
  - **運用**: 4プラグイン(インシデント、診断、分散、可観測性)
  - **言語**: 7プラグイン(Python、JS/TS、システム、JVM、スクリプト、関数型、組み込み)
  - **インフラストラクチャ**: 5プラグイン(デプロイメント、検証、K8s、クラウド、CI/CD)
  - その他18の専門カテゴリー

### コンポーネント内訳

**85個の専門エージェント**
- 深い知識を持つドメインエキスパート
- アーキテクチャ、言語、インフラストラクチャ、品質、データ/AI、ドキュメント、ビジネス、SEO全体に整理
- モデル最適化(Haiku 47個、Sonnet 97個)でパフォーマンスとコストを最適化

**15個のワークフローオーケストレーター**
- マルチエージェント調整システム
- フルスタック開発、セキュリティ強化、MLパイプライン、インシデント対応などの複雑な操作
- 事前設定されたエージェントワークフロー

**44個の開発ツール**
- 最適化されたユーティリティ:
  - プロジェクトスキャフォールディング(Python、TypeScript、Rust)
  - セキュリティスキャン(SAST、依存関係監査、XSS)
  - テスト生成(pytest、Jest)
  - コンポーネントスキャフォールディング(React、React Native)
  - インフラストラクチャセットアップ(Terraform、Kubernetes)

**47個のエージェントスキル**
- モジュラー知識パッケージ
- プログレッシブ・ディスクロージャーアーキテクチャ
- 14プラグインにまたがるドメイン固有の専門知識
- 仕様準拠(Anthropic Agent Skills Specification)

## リポジトリ構造

```
claude-agents/
├── .claude-plugin/
│   └── marketplace.json          # マーケットプレイスカタログ(63プラグイン)
├── plugins/                       # 分離されたプラグインディレクトリ
│   ├── python-development/
│   │   ├── agents/               # Python言語エージェント
│   │   │   ├── python-pro.md
│   │   │   ├── django-pro.md
│   │   │   └── fastapi-pro.md
│   │   ├── commands/             # Pythonツール
│   │   │   └── python-scaffold.md
│   │   └── skills/               # Pythonスキル(合計5個)
│   │       ├── async-python-patterns/
│   │       ├── python-testing-patterns/
│   │       ├── python-packaging/
│   │       ├── python-performance-optimization/
│   │       └── uv-package-manager/
│   ├── backend-development/
│   │   ├── agents/
│   │   │   ├── backend-architect.md
│   │   │   ├── graphql-architect.md
│   │   │   └── tdd-orchestrator.md
│   │   ├── commands/
│   │   │   └── feature-development.md
│   │   └── skills/               # バックエンドスキル(合計3個)
│   │       ├── api-design-principles/
│   │       ├── architecture-patterns/
│   │       └── microservices-patterns/
│   ├── security-scanning/
│   │   ├── agents/
│   │   │   └── security-auditor.md
│   │   ├── commands/
│   │   │   ├── security-hardening.md
│   │   │   ├── security-sast.md
│   │   │   └── security-dependencies.md
│   │   └── skills/               # セキュリティスキル(合計1個)
│   │       └── sast-configuration/
│   └── ... (さらに60個の分離されたプラグイン)
├── docs/                          # ドキュメント
│   ├── agent-skills.md           # Agent Skillsガイド
│   ├── agents.md                 # エージェントリファレンス
│   ├── plugins.md                # プラグインカタログ
│   ├── usage.md                  # 使用ガイド
│   └── architecture.md           # このファイル
└── README.md                      # クイックスタート
```

## プラグイン構造

各プラグインには以下が含まれます:

- **agents/** - そのドメイン用の専門エージェント(オプション)
- **commands/** - そのプラグイン固有のツールとワークフロー(オプション)
- **skills/** - プログレッシブ・ディスクロージャーを使用したモジュラー知識パッケージ(オプション)

### 最小要件

- 少なくとも1つのエージェントまたは1つのコマンド
- 明確で焦点を絞った目的
- すべてのファイルの適切なフロントマター
- marketplace.jsonへのエントリ

### プラグインの例

```
plugins/kubernetes-operations/
├── agents/
│   └── kubernetes-architect.md   # K8sアーキテクチャと設計
├── commands/
│   └── k8s-deploy.md            # デプロイメント自動化
└── skills/
    ├── k8s-manifest-generator/   # マニフェスト作成スキル
    ├── helm-chart-scaffolding/   # Helmチャートスキル
    ├── gitops-workflow/          # GitOps自動化スキル
    └── k8s-security-policies/    # セキュリティポリシースキル
```

## Agent Skillsアーキテクチャ

### プログレッシブ・ディスクロージャー

スキルは、トークン効率のために3層アーキテクチャを使用します:

1. **メタデータ** (フロントマター): 名前とアクティベーション条件(常に読み込み)
2. **指示**: コアガイダンスとパターン(アクティベート時に読み込み)
3. **リソース**: 例とテンプレート(オンデマンドで読み込み)

### 仕様準拠

すべてのスキルは[Agent Skills Specification](https://github.com/anthropics/skills/blob/main/agent_skills_spec.md)に準拠しています:

```yaml
---
name: skill-name                  # 必須: ハイフンケース
description: スキルの機能。Use when [トリガー]. # 必須: < 1024文字
---

# プログレッシブ・ディスクロージャーを使用したスキルコンテンツ
```

### メリット

- **トークン効率**: 必要な知識のみを必要な時に読み込み
- **専門知識**: 肥大化なしの深いドメイン知識
- **明確なアクティベーション**: 明示的なトリガーで不要な呼び出しを防止
- **組み合わせ可能性**: ワークフロー全体でスキルをミックス&マッチ
- **保守性**: 分離された更新が他のスキルに影響を与えない

詳細は[Agent Skills](./agent-skills.md)の47スキルの完全な情報を参照してください。

## モデル構成戦略

### 2層アーキテクチャ

システムは戦略的にClaude OpusとSonnetモデルを使用します:

| モデル | 数 | ユースケース |
|-------|-------|----------|
| Haiku | 47エージェント | 高速実行、決定的タスク |
| Sonnet | 97エージェント | 複雑な推論、アーキテクチャ決定 |

### 選択基準

**Haiku - 高速実行 & 決定的タスク**
- 明確に定義された仕様からのコード生成
- 確立されたパターンに従ったテスト作成
- 明確なテンプレートを使用したドキュメント作成
- インフラストラクチャ操作の実行
- データベースクエリ最適化の実行
- カスタマーサポート応答の処理
- SEO最適化タスクの処理
- デプロイメントパイプラインの管理

**Sonnet - 複雑な推論 & アーキテクチャ**
- システムアーキテクチャの設計
- 技術選択の意思決定
- セキュリティ監査の実行
- アーキテクチャパターンのコードレビュー
- 複雑なAI/MLパイプラインの作成
- 言語固有の専門知識の提供
- マルチエージェントワークフローのオーケストレーション
- ビジネスクリティカルな法務/HR事項の処理

### ハイブリッドオーケストレーション

最適なパフォーマンスとコストのためにモデルを組み合わせます:

```
計画フェーズ(Sonnet) → 実行フェーズ(Haiku) → レビューフェーズ(Sonnet)

例:
backend-architect (Sonnet) がAPIを設計
  ↓
エンドポイント生成 (Haiku) が仕様を実装
  ↓
test-automator (Haiku) がテストを作成
  ↓
code-reviewer (Sonnet) がアーキテクチャを検証
```

## パフォーマンス & 品質

### 最適化されたトークン使用

- **分離されたプラグイン** 必要なものだけを読み込み
- **粒度の高いアーキテクチャ** 不要なコンテキストを削減
- **プログレッシブ・ディスクロージャー** (スキル) 知識をオンデマンドで読み込み
- **明確な境界** コンテキスト汚染を防止

### コンポーネントカバレッジ

- **100%エージェントカバレッジ** - すべてのプラグインに少なくとも1つのエージェントを含む
- **100%コンポーネント可用性** - すべての85エージェントがプラグイン全体でアクセス可能
- **効率的な分布** - プラグインあたり平均3.4コンポーネント

### 発見可能性

- **明確なプラグイン名** 目的を即座に伝える
- **論理的なカテゴリー化** 23の明確に定義されたカテゴリー
- **検索可能なドキュメント** 相互参照付き
- **簡単に見つかる** 仕事に適したツール

## 設計パターン

### パターン1: 単一目的プラグイン

各プラグインは1つのドメインに焦点を当てます:

```
python-development/
├── agents/           # Python言語エキスパート
├── commands/         # Pythonプロジェクトスキャフォールディング
└── skills/           # Python固有の知識
```

**メリット:**
- 明確な責任
- 保守が容易
- 最小限のトークン使用
- 他のプラグインとの組み合わせ可能

### パターン2: ワークフローオーケストレーション

オーケストレータープラグインが複数のエージェントを調整:

```
full-stack-orchestration/
└── commands/
    └── full-stack-feature.md    # 7個以上のエージェントを調整
```

**オーケストレーション:**
1. backend-architect (APIを設計)
2. database-architect (スキーマを設計)
3. frontend-developer (UIを構築)
4. test-automator (テストを作成)
5. security-auditor (セキュリティレビュー)
6. deployment-engineer (CI/CD)
7. observability-engineer (監視)

### パターン3: エージェント + スキル統合

エージェントが推論を提供し、スキルが知識を提供:

```
ユーザー: "Build FastAPI project with async patterns"
  ↓
fastapi-pro エージェント (オーケストレート)
  ↓
fastapi-templates スキル (パターンを提供)
  ↓
python-scaffold コマンド (プロジェクトを生成)
```

### パターン4: マルチプラグイン構成

複雑なワークフローが複数のプラグインを使用:

```
機能開発ワークフロー:
1. backend-development:feature-development
2. security-scanning:security-hardening
3. unit-testing:test-generate
4. code-review-ai:ai-review
5. cicd-automation:workflow-automate
6. observability-monitoring:monitor-setup
```

## バージョニング & 更新

### マーケットプレイス更新

- `.claude-plugin/marketplace.json`のマーケットプレイスカタログ
- プラグインのセマンティックバージョニング
- 後方互換性の維持
- 破壊的変更のための明確な移行ガイド

### プラグイン更新

- 個別のプラグイン更新は他に影響を与えない
- スキルは独立して更新可能
- エージェントはワークフローを壊すことなく追加/削除可能
- コマンドは安定したインターフェースを維持

## コントリビューションガイドライン

### プラグインの追加

1. プラグインディレクトリを作成: `plugins/{plugin-name}/`
2. エージェントおよび/またはコマンドを追加
3. オプションでスキルを追加
4. marketplace.jsonを更新
5. 適切なカテゴリーにドキュメント化

### エージェントの追加

1. `plugins/{plugin-name}/agents/{agent-name}.md`を作成
2. フロントマターを追加(名前、説明、モデル)
3. 包括的なシステムプロンプトを記述
4. プラグイン定義を更新

### スキルの追加

1. `plugins/{plugin-name}/skills/{skill-name}/SKILL.md`を作成
2. YAMLフロントマターを追加(名前、「Use when」付きの説明)
3. プログレッシブ・ディスクロージャーでスキルコンテンツを記述
4. marketplace.jsonのプラグインのスキル配列に追加

### 品質基準

- **明確な命名** - ハイフンケース、説明的
- **焦点を絞ったスコープ** - 単一責任
- **完全なドキュメント** - 何を、いつ、どのように
- **テスト済み機能** - コミット前に検証
- **仕様準拠** - Anthropicガイドラインに従う

## 関連項目

- [Agent Skills](./agent-skills.md) - モジュラー知識パッケージ
- [Agent Reference](./agents.md) - 完全なエージェントカタログ
- [Plugin Reference](./plugins.md) - 全63プラグイン
- [Usage Guide](./usage.md) - コマンドとワークフロー
